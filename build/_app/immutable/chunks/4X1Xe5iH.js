import{e as C}from"./C_6UiiDj.js";import{a as m,u as I,L as i,O as h,p as l,l as v}from"./B2N5e1u8.js";import{a as c}from"./jPXH___Y.js";import{S as x}from"./8gq2Ynae.js";function R(){const e=localStorage.getItem(i.gradebook);if(e===null)return;const o=JSON.parse(e),r=o.recordCache[o.defaultIndex],t=r?l(r.xml).ReportingPeriods.ReportPeriod:void 0;return{recordCache:o.recordCache.map(d=>d??void 0),defaultIndex:o.defaultIndex,overrideIndex:o.overrideIndex??void 0,canonicalReportPeriodEntries:t}}function S(e){const o={recordCache:e.recordCache.map(r=>r??null),defaultIndex:e.defaultIndex,overrideIndex:e.overrideIndex??null};localStorage.setItem(i.gradebook,JSON.stringify(o))}async function k(e,o){const{studentAccount:r}=m;if(!r)throw new Error("Cannot get synergy gradebook: student account not loaded");const t=await r.gradebookRequest(o);e?.();const n=await t.text();return{xml:I(n,h.Request),lastRefresh:Date.now()}}async function w(){const e=await k(),o=l(e.xml),r=o.ReportingPeriods.ReportPeriod,t=Array(r.length).fill(void 0),n=parseInt(o.ReportingPeriod._Index);return t[n]=e,{recordCache:t,defaultIndex:n,canonicalReportPeriodEntries:r}}const P=1e3*60*5,y=e=>Date.now()-e.lastRefresh>P;function E(){const e=localStorage.getItem(i.seenAssignmentIDs);if(e===null)return;const o=JSON.parse(e),r=new Set;return o.forEach(t=>r.add(t)),r}const D=e=>localStorage.setItem(i.seenAssignmentIDs,JSON.stringify([...e])),s=new x;try{const e=E();e&&e.forEach(o=>s.add(o))}catch(e){console.error(e),localStorage.removeItem(i.seenAssignmentIDs)}const a=C({}),p=e=>a.gradebookCatalog?.canonicalReportPeriodEntries?.[e]?._GradePeriod??`Report Period ${e}`,A=()=>{a.gradebookCatalog&&(a.gradebookCatalog.receivingData=!0)};async function f({overrideIndex:e,forceRefresh:o}={}){if(!a.gradebookCatalog)throw new Error("Cannot switch report periods: gradebook catalog not initialized");const r=e??a.gradebookCatalog.defaultIndex;a.gradebookCatalog.loadingIndex=r;const t=a.gradebookCatalog.recordCache[r];if(t&&u(e??a.gradebookCatalog.defaultIndex),o||!t||y(t)){a.gradebookCatalog.receivingData=!1;const n=await k(A,e),d=l(n.xml),g=parseInt(d.ReportingPeriod._Index);a.gradebookCatalog.recordCache[g]=n,e===void 0&&(a.gradebookCatalog.defaultIndex=g,a.gradebookCatalog.canonicalReportPeriodEntries=d.ReportingPeriods.ReportPeriod),g!==r?e===void 0?c(`${d.ReportingPeriod._GradePeriod} is now the default`,"info",6e3):c(`${p(r)} is not available`,"error",6e3):a.gradebookCatalog.overrideIndex=e!==a.gradebookCatalog.defaultIndex?e:void 0}else u(e??a.gradebookCatalog.defaultIndex);a.gradebookCatalog.loadingIndex=void 0,S(a.gradebookCatalog)}function u(e){if(!a.gradebookCatalog)throw new Error("Cannot set report period index: gradebook catalog not initialized");a.gradebookCatalog.overrideIndex=e!==a.gradebookCatalog.defaultIndex?e:void 0}async function G(){let e;try{e=R()}catch(o){console.error("Error loading gradebook cache:",o),c("Failed to load saved gradebook data; refreshing","error",6e3),localStorage.removeItem(i.gradebook)}return e??await w()}let b=!1;async function _(){if(!b)try{v(),a.gradebookCatalog=await G(),s.size===0&&(a.gradebookCatalog.recordCache.filter(o=>o!==void 0).flatMap(o=>l(o.xml).Courses.Course).map(o=>o.Marks).filter(o=>o!=="").map(o=>o.Mark.Assignments.Assignment).filter(o=>o!==void 0).flat().forEach(o=>s.add(o._GradebookID)),D(s));const{overrideIndex:e}=a.gradebookCatalog;if(e!==void 0)try{await f({overrideIndex:e})}catch(o){console.error(`Error loading override report period ${e}; reverting to default`,o),c(`Failed to load grades from ${p(e)}; loading default period instead`,"error",6e3),await f()}else await f()}catch(e){console.error("Error loading grades:",e),a.loadingError=e}finally{b=!0}}export{p as a,s as b,D as c,a as g,_ as i,f as s};
